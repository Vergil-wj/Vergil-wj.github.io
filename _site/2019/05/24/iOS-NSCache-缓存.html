<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>iOS NSCache 缓存</title>
  <meta name="description" content="NSCache 是一个可变集合，即缓存。它存储key-value对，这一点类似于NSDictionary类。">
  <meta name="author" content="leopardpan">

  <!-- <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="iOS NSCache 缓存">
  <meta name="twitter:description" content="NSCache 是一个可变集合，即缓存。它存储key-value对，这一点类似于NSDictionary类。"> -->
  
  <meta property="og:type" content="article">
  <meta property="og:title" content="iOS NSCache 缓存">
  <meta property="og:description" content="NSCache 是一个可变集合，即缓存。它存储key-value对，这一点类似于NSDictionary类。">
  
  <link rel="icon" type="image/png" href="/images/favicon.png" />
  <link href="/images/favicon.png" rel="shortcut icon" type="image/png">
  
  <link rel="stylesheet" href="/css/main.css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="http://localhost:4000/2019/05/24/iOS-NSCache-%E7%BC%93%E5%AD%98.html">
  <link rel="alternate" type="application/rss+xml" title="Vergil" href="http://localhost:4000/feed.xml">
  
  <!-- <meta name="google-site-verification" content="1-1ZlHoRvM0T2FqPbW2S-qLgYXN6rsn52kErlMPd_gw" /> -->



</head>


  <body>

    <span class="mobile btn-mobile-menu">        
      <div class="nav_container">
         <nav class="nav-menu-item" style = "float:right">
            <i class="nav-menu-item">
              <a href="/#blog" title="" class="blog-button">  博客主页
              </a>
            </i>
            
                <i class="nav-menu-item">

                  <a href="/archive" title="archive" class="btn-mobile-menu__icon">
                      所有文章
                  </a>
                </i>
            
                <i class="nav-menu-item">

                  <a href="/tags" title="tags" class="btn-mobile-menu__icon">
                      标签
                  </a>
                </i>
            
          </nav>
      </div>
    </span>
    
    <header class="panel-cover panel-cover--collapsed" style="background-image: url('/images/background-cover.jpg')">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
        <div class="panel-main__content">
            <!-- 头像效果-start -->
            <div class="ih-item circle effect right_to_left">            
                <a href="/#blog" title="前往 Vergil 的主页" class="blog-button">
                    <div class="img"><img src="/images/avatar.jpg" alt="img"></div>
                    <div class="info">
                        <div class="info-back">
                            <h2> 
                                
                                Vergil
                                
                            </h2>
                            <p>
                             
                             iOS
                             
                         </p>
                     </div>
                 </div>
             </a>
         </div>
         <!-- 头像效果-end -->
         <h1 class="panel-cover__title panel-title"><a href="/#blog" title="link to homepage for Vergil" class="blog-button">Vergil</a></h1>

         
         <span class="panel-cover__subtitle panel-subtitle">iOS 开发者</span>
         

         <hr class="panel-cover__divider" />
         <p class="panel-cover__description">我用双手成就你的梦想！</p>
         <hr class="panel-cover__divider panel-cover__divider--secondary" />

         


         <div class="navigation-wrapper">
          <div>
            <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">博客主页</a></li>
                
                <li class="navigation__item"><a href="/archive" title="archive">所有文章</a></li>
                
                <li class="navigation__item"><a href="/tags" title="tags">标签</a></li>
                
            </ul>
        </nav>
    </div>          
</div>


</div>
</div>
</div>


<div class="panel-cover--overlay cover-clear"></div>

</div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title">iOS NSCache 缓存</h1>
    <div class="post-meta"> 
      <time datetime="2019-05-24 00:00:00 +0800" itemprop="datePublished" class="post-meta__date date">2019-05-24</time>  
    </div>
  </header>

  <section class="post">
    <p>NSCache 是一个可变集合，即缓存。它存储key-value对，这一点类似于NSDictionary类。</p>

<ul>
  <li>
    <p>NSCache 在系统内存很低时，会自动释放一些对象</p>
  </li>
  <li>
    <p>NSCache 是线程安全的，在多线程操作中，不需要对 Cache 加锁</p>
  </li>
  <li>
    <p>NSCache 的 Key 只是做强引用，不需要实现 NSCopying 协议</p>
  </li>
</ul>

<h3 id="属性">属性</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//缓存名
- @property (copy) NSString *name;

//缓存所能容纳最大总成本。
//默认为 0，没有限制。
//但需要注意的是，这不是一个严格的限制。如果缓存的数量超过这个数量，缓存中的一个对象可能会被立即丢弃、或者稍后、也可能永远不会，具体依赖于缓存的实现细节。
- @property NSUInteger totalCostLimit;	

//缓存对象最大数量。
//默认为 0，没有限制。
//被丢弃的对象的顺序无法保证，同totalCostLimit 限制策略一样。
- @property NSUInteger countLimit;	

//标示缓存是否回收废弃的内容。
//默认值是 YES，表示自动回收。
- @property BOOL evictsObjectsWithDiscardedContent;
</code></pre></div></div>

<h3 id="方法">方法</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//返回键值关联对象
- (nullable ObjectType)objectForKey:(KeyType)key;

//在缓存个中设置指定键名对应的值
//与可变字典不同，缓存对象不会对键名做 copy 操作
- (void)setObject:(ObjectType)obj forKey:(KeyType)key; // 0 cost

//在缓存中设置指定键名对应的值，并且指定该键值对的成本
//成本 (cost) 用于计算记录在缓冲中的所有对象的总成本，成本可以自行指定
- (void)setObject:(ObjectType)obj forKey:(KeyType)key cost:(NSUInteger)g;

//移除指定键关联的对象
- (void)removeObjectForKey:(KeyType)key;

//移除所有缓存对象
- (void)removeAllObjects;
</code></pre></div></div>

<h3 id="代理">代理</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@property(assign) id&lt; NSCacheDelegate &gt; delegate

//缓存将要删除对象时调用
//不能在此方法中修改缓存
- (void)cache:(NSCache *)cache willEvictObject:(id)obj;
</code></pre></div></div>

<h3 id="成本的理解">成本的理解</h3>

<p>在上述提到的属性和方法中：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- @property NSUInteger totalCostLimit;	

- (void)setObject:(ObjectType)obj forKey:(KeyType)key cost:(NSUInteger)g;
</code></pre></div></div>

<p>这两个是搭配使用的，其中<code class="highlighter-rouge">totalCostLimit</code>控制最大成本，限制缓存大小。
<code class="highlighter-rouge">setObject: forKey: cost:</code>其中 cost 表示当前对象的大小。</p>

<p>比如，我们希望用我们的缓存来存储图片，我们限制图片缓存的总成本为 10M。</p>

<p>那么我们我们可以这么设置：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_cache.totalCostLimit = 10; //假设我们的单位为 M
</code></pre></div></div>

<p>当我们添加图片到缓存中的时候，可以如下添加</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[_cache setObject:image forKey:key cost:5];//假设我们的图片大小 5M
</code></pre></div></div>

<p>那么我们添加第一、二个图片的时候，就会存入到图片缓存中（假设图片大小都是5M）。现在我们来添加第三张图片，发现我们的缓存已经到了最大值，我们无法添加，
那么 NSCache,就会把第一张图片从缓存中删除，然后来检查是空间是否已经足够添加第三张图片了，如果不够，那么继续删除第二张，如果够了，那么把第三张图片添加到缓存中。</p>

<p>这是我们假设的一个例子，实际开发中我们并不知道图片的大小。通常，精确的 cost 应该是对象占用的字节数。如果它不可以直接读出来的话，你没必要费劲地去计算它，因为这么做的话会增加使用缓存的代价，导致性能变差。</p>

<p>所以</p>

<blockquote>
  <p>如果你没有有效的值传入，那就传入 0，或者用 setObject:forKey: 方法，它不需要传入 cost 值。</p>
</blockquote>

<h3 id="代码示例">代码示例</h3>

<p>声明 NSCache 变量：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@property (nonatomic, strong) NSCache *cache;
</code></pre></div></div>

<p>懒加载：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- (NSCache *)cache {
    if (_cache == nil) {
        _cache = [[NSCache alloc] init];
        // 设置数量限制,最大限制为3
        _cache.countLimit = 3;
        _cache.delegate = self;
    }
    return _cache;
}
</code></pre></div></div>

<p>测试方法：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//添加缓存
-(void)addCache{
    for (int i = 0 ; i &lt; 5 ; i++) {
        NSString *str = [NSString stringWithFormat:@"在这里进行了存储数据：%d",i];
        [self.cache setObject:str forKey:@(i)];
        NSLog(@"存储数据----%@",@(i));
    }
}

// 检查缓存
- (void)checkCache {
    NSLog(@"---------------------------------------------");
    for (int i = 0; i &lt; 5 ; i++) {
        NSString *str = [self.cache objectForKey:@(i)];
        if (str) {
            NSLog(@"取出缓存中存储的数据-----%@",@(i));
        }
    }
}

#pragma mark - NSCacheDelegate
// 即将回收对象的时候进行调用，实现代理方法之前要遵守NSCacheDelegate协议。
- (void)cache:(NSCache *)cache willEvictObject:(id)obj{
    NSLog(@"回收--------%@",obj);
}
</code></pre></div></div>

<p>运行，点击添加缓存按钮：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>存储数据----0
存储数据----1
存储数据----2
回收--------在这里进行了存储数据：0
存储数据----3
回收--------在这里进行了存储数据：1
存储数据----4
</code></pre></div></div>

<p>因为我们设置 _cache.countLimit = 3，所以在存储第四条数据时，先释放了第一条数据，在添加第四条数据，第五条数据也是如此。</p>

<p>点击查看缓存按钮验证下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>取出缓存中存储的数据-----2
取出缓存中存储的数据-----3
取出缓存中存储的数据-----4
</code></pre></div></div>

<p>缓存中只有三条数据，与我们设置的 countLimi 为 3 一致。</p>


  </section>

</article>

<section>

  <div style="text-align:center;margin:50px 0; font:normal 14px/24px 'MicroSoft YaHei';"></div>

  <ul class="pager">
    
    <li class="previous">
      <a href="/2019/05/23/Effective-Objective-C-2.0-%E7%AC%AC%E4%B8%83%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E6%A1%86%E6%9E%B6.html" data-toggle="tooltip" data-placement="top" title="Effective Objective-C 2.0 第七章 系统框架">上一篇：  <span>Effective Objective-C 2.0 第七章 系统框架</span>
      </a>
    </li>
    
    
  </ul>
</section>


            <section class="footer">
  <footer>
    <div class = "footer_div">  
      <nav class="cover-navigation navigation--social">
        <ul class="navigation">

          
          <!-- Github -->
          <li class="navigation__item_social">
            <a href="https://github.com/Vergil-wj" title="@Vergil-wj 的 Github" target="_blank">
              <div class="footer-social-icon" style="background:url(/images/github.png);"></div>
            </a>
          </li>
          

          
          <li class="navigation__item_social">
            <a href="https://www.jianshu.com/u/3e3ba42c4c63" title="@3e3ba42c4c63" target="_blank">
              <div class="footer-social-icon" style="background:url(/images/jianshu.jpg);"></div>
            </a>
          </li>

          

          
          <!-- Email -->
          <li class="navigation__item_social">
            <a href="mailto:834372189@qq.com" title="Contact me">
              <div class="footer-social-icon" style="background:url(/images/email.png);"></div>
            </a>
          </li>
          
          
        </ul>
      </nav>

    </div>

    <div class = "footer_div">  

      <div align="center">
        <p class="copyright text-muted">
          Copyright &copy; Vergil 2019
        </p>
        <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
      </div>

    </div>
  </footer>
</section>

        </div>
    </div>
    
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

<script type="text/javascript" src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



    
  </body>

</html>
